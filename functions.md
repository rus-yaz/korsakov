# Exec

Функции исполнения терминальных команд

## `run(command, args, env, wait)`

Исполнение терминальной команды

Возвращаемое значение: -

| Имя аргумента | Описание                              |
| :-----------: | ------------------------------------- |
|   `command`   | Буфер с командой                      |
|    `args`     | Буфер с аргументами команды           |
|     `env`     | Буфер с переменными среды             |
|    `wait`     | Ожидать ли окончания исполнения (1/0) |

# File

Функции, связанные с файлами

## `get_file_size(filename)`

Получение размера файла в байтах

Возвращаемое значение: число

| Имя аргумента | Описание             |
| :-----------: | -------------------- |
|  `filename`   | Буфер с именем файла |

## `open_file(filename, flags = O_RDONLY, mode = 444o)`

Открытие файла

Возвращаемое значение: указатель на файл

| Имя аргумента | Описание                                                                                                                    |
| :-----------: | --------------------------------------------------------------------------------------------------------------------------- |
|  `filename`   | Буфер с именем файла                                                                                                        |
|    `flags`    | Число (8-ричное), отвечающее за права, с которыми открывается файл (см. [`lib/syscalls_amd64.asm`](lib/syscalls_amd64.asm)) |
|    `mode`     | Права файла, если он не существовал и будет создан                                                                          |

## `close_file(file)`

Закрытие файла

Возвращаемое значение: -

| Имя аргумента | Описание                       |
| :-----------: | ------------------------------ |
|    `file`     | Указатель на файл для закрытия |

## `read_file(file)`

Чтение файла

Возвращаемое значение: указатель на строку

| Имя аргумента | Описание                     |
| :-----------: | ---------------------------- |
|    `file`     | Указатель на файл для чтения |

## `write_file(file, string)`

Запись строки в файл

Возвращаемое значение: -

| Имя аргумента | Описание                       |
| :-----------: | ------------------------------ |
|    `file`     | Указатель на файл для записи   |
|   `string`    | Указатель на строку для записи |

# Functions

Более общие функции

## `is_equal(val_1, val_2)`

Сравнение двух значений

Возвращаемое значение: число (1/0)

| Имя аргумента | Описание                      |
| :-----------: | ----------------------------- |
|    `val_1`    | Первое значение для сравнения |
|    `val_2`    | Второе значение для сравнения |

# Heap

Функции для взаимодействия с кучей

## `write_header(addr, header_sign, size, prev_size, state)`

Запись значений по адресу

Возвращаемое значение: -

| Имя аргумента | Описание                              |
| :-----------: | ------------------------------------- |
|    `addr`     | Адрес на куче                         |
| `header_sign` | Тип блока кучи                        |
|    `size`     | Размер блока                          |
|  `prev_size`  | Размер предыдущего блока              |
|    `state`    | Состояние блока (0 — не используется) |

## `allocate_heap()`

Обязательно в начале программы. Аллоцирует кучу (размер — `HEAP_SIZE`), помещая в `HEAP_START` указатель на начало кучи, `HEAP_END` — конец кучи

Возвращаемое значение: -

## `expand_heap(size)`

Расширяет кучу

Возвращаемое значение: -

| Имя аргумента | Описание                                         |
| :-----------: | ------------------------------------------------ |
|    `size`     | Количество байт, на которое будет увеличена куча |

## `create_block(size)`

Создание блока на куче

Возвращаемое значение: указатель на тело блока

| Имя аргумента | Описание                            |
| :-----------: | ----------------------------------- |
|    `size`     | Количество байт, выделяемое на блок |

## `delete_block(block)`

Удаление блока с кучи (установка его состояния на 0)

# Integer

Функции, связанные с типом Целое число

## `integer(value)`

Добавляет значение с типом Целое число на стек. Для взаимодействия после использования нужно использовать `rsp` как указатель на значение

Возвращаемое значение: -

| Имя аргумента | Описание    |
| :-----------: | ----------- |
|    `value`    | Целое число |

# List

Функции, связанные с типом Список

## `list(list_start, length)`

Копирует значения в список на куче

Возвращаемое значение: указатель на значение

| Имя аргумента | Описание                               |
| :-----------: | -------------------------------------- |
| `list_start`  | Указатель на начало последовательности |
|   `length`    | Количество элементов                   |

## `list_length(list)`

Возвращает длину списка

Возвращаемое значение: число

| Имя аргумента | Описание            |
| :-----------: | ------------------- |
|    `list`     | Указатель на список |

## `list_get(list, index)`

Возвращает элемент по индексу

Возвращаемое значение: элемент списка

| Имя аргумента | Описание            |
| :-----------: | ------------------- |
|    `list`     | Указатель на список |
|    `index`    | Указатель на число  |

# String

Функции, связанные с типом Строка

## `get_string_length(string)`

Возвращает длину строки

Возвращаемое значение: число

| Имя аргумента | Описание            |
| :-----------: | ------------------- |
|   `string`    | Указатель на строку |

## `string_get(string, index)`

Возвращает элемент по индексу. Создаёт новую строку на куче длиной в один символ и возвращает указатель на неё

Возвращаемое значение: указатель на строку

| Имя аргумента | Описание            |
| :-----------: | ------------------- |
|   `string`    | Указатель на строку |
|    `index`    | Указатель на число  |

# Syscalls (`amd64`)

Функции, связанные с системными вызовами под `amd64` (`x86_64`)

## `syscall(number, arg_1 = 0, arg_2 = 0, arg_3 = 0, arg_4 = 0, arg_5 = 0, arg_6 = 0)`

Прямой системный вызов

Возвращаемое значение: число

|  Имя аргумента  | Описание                |
| :-------------: | ----------------------- |
|    `number`     | Номер системного вызова |
| `arg_1...arg_6` | Аргументы               |

## `sys_read(file_descriptor, buffer_ptr, size)`

Вызов `SYS_READ`, чтение по файловому дескриптору

Возвращаемое значение: количество прочитанных байт

|   Имя аргумента   | Описание                                    |
| :---------------: | ------------------------------------------- |
| `file_descriptor` | Файловый дескриптор, место чтение           |
|   `buffer_ptr`    | Указатель на сегмент памяти, место записи   |
|      `size`       | Размер читаемой последовательности в байтах |

## `sys_write(file_descriptor, buffer_ptr, size)`

Вызов `SYS_WRITE`, запись по файловому дескриптору

Возвращаемое значение: количество записанных байт

|   Имя аргумента   | Описание                                    |
| :---------------: | ------------------------------------------- |
| `file_descriptor` | Файловый дескриптор, место записи           |
|   `buffer_ptr`    | Указатель на сегмент памяти, место чтения   |
|      `size`       | Размер читаемой последовательности в байтах |

## `sys_open(filename, flags, mode)`

Вызов `SYS_OPEN`, открытие файла

Возвращаемое значение: -

| Имя аргумента | Описание                                                                     |
| :-----------: | ---------------------------------------------------------------------------- |
|  `filename`   | Буфер с именем файла                                                         |
|    `flags`    | Флаги доступа файла (см. [`lib/syscalls_amd64.asm`](lib/syscalls_amd64.asm)) |
|    `mode`     | Права файла при создании                                                     |

## `sys_close(file_descriptor)`

Вызов `SYS_CLOSE`, закрытие по файловому дескриптору

Возвращаемое значение: -

|   Имя аргумента   | Описание            |
| :---------------: | ------------------- |
| `file_descriptor` | Файловый дескриптор |

## `sys_stat(filename, buffer_ptr)

Вызов `SYS_STAT`, получение данных о файле

Возвращаемое значение: -

| Имя аргумента | Описание                                  |
| :-----------: | ----------------------------------------- |
|  `filename`   | Буфер с именем файла                      |
| `buffer_ptr`  | Указатель на сегмент памяти, место записи |

## `sys_mmap(addr, length, rights, flags, file_descriptor, offset)

Вызов `SYS_MMAP`, аллокация памяти для кучи

Возвращаемое значение: указатель на выделенный сегмент памяти

|   Имя аргумента   | Описание                                |
| :---------------: | --------------------------------------- |
|      `addr`       | Адрес (если 0, находится автоматически) |
|     `length`      | Количество памяти для аллокации         |
|     `rights`      | Права (`PROT_READ` \| `PROT_WRITE`)     |
|      `flags`      | `MAP_ANONYMOUS` \| `MAP_PRIVATE`        |
| `file_descriptor` | Файловый дескриптор                     |
|     `offset`      | Смещение относительно начала файла      |

## `sys_munmap(addr, length)`

Вызов `SYS_MUNMAP`, деаллокация кучи

Возвращаемое значение: -

| Имя аргумента | Описание                      |
| :-----------: | ----------------------------- |
|    `addr`     | Указатель на сегмент памяти   |
|   `length`    | Количество памяти для очистки |

## `sys_exit(error_code)`

Вызов `SYS_EXIT`, завершение процесса

Возвращаемое значение: -

| Имя аргумента | Описание   |
| :-----------: | ---------- |
| `error_code`  | Код выхода |

## `sys_fork()`

Создание дочернего процесса или, если выполнен в дочернем процессе, возвращает 0

Возвращаемое значение: идентификатор дочернего или 0

## `sys_execve(command, args, env)`

Выполнение терминальной команды

Возвращаемое значение: идентификатор дочернего или 0

| Имя аргумента | Описание                    |
| :-----------: | --------------------------- |
|   `command`   | Буфер с командой            |
|    `args`     | Буфер с аргументами команды |
|     `env`     | Буфер с переменными среды   |

## `sys_wait4(pid)`

Ожидание завершения определённого процесса

Возвращаемое значение: -

| Имя аргумента | Описание               |
| :-----------: | ---------------------- |
|     `pid`     | Идентификатор процесса |

# Utils

Функции упрощения для языка Ассемблера

## `push(*arg)`

Облегчение для многократного использования операции `push`

Возвращаемое значение: -

| Имя аргумента | Описание                                                            |
| :-----------: | ------------------------------------------------------------------- |
|     `arg`     | Аргумент-аккумулятор для значений, которые будут отправлены на стек |

## `pop(*arg)`

Облегчение для многократного использования операции `push`

Возвращаемое значение: -

| Имя аргумента | Описание                                                                         |
| :-----------: | -------------------------------------------------------------------------------- |
|     `arg`     | Аргумент-аккумулятор для регистров, в которые будут отправлены значения со стека |

## `enter(arg_1 = 0, arg_2 = 0, arg_3 = 0, arg_4 = 0, arg_5 = 0, arg_6 = 0, arg_7 = 0, arg_8 = 0, arg_9 = 0, arg_10 = 0, arg_11 = 0, arg_12 = 0)`

Операция входа в функцию. Сохраняет значения всех регистров (`a-d`, `si`, `di`, `8-15`) на стеке и сохраняет переданные значения в регистры `a-d` и `8-15`. Используется в паре с [`leave`](<#leave()>) или [`return`](<#return()>) при создании новых макросов для функций

Возвращаемое значение: -

|  Имя аргумента   | Описание                                                   |
| :--------------: | ---------------------------------------------------------- |
| `arg_1...arg_12` | Аргументы, которые будут переданы в регистры `a-d`, `8-15` |

## `leave()`

Операция выхода из функции. Забирает значения со стека для всех регистров (`15-8`, `di`, `si`, `d-a`). Используется в паре с [`enter`](<#enter()>) при создании новых макросов для функций. Может быть заменён на [`return`](<#return()>) для сохранения значения в регистре `rax`

Возвращаемое значение: -

## `return()`

Операция выхода из функции. Забирает значения со стека для всех регистров (`15-8`, `di`, `si`, `d-b`), не затрагивая значение в `rax`. Используется в паре с [`enter`](<#enter()>) при создании новых макросов для функций. Может быть заменён на [`leave`](<#leave()>) для возвращения исходного значения регистра `rax`

Возвращаемое значение: -

## `mem_mov(destination, source)`

Облегчение для использования операции `mov` для различных типов источника и мест назначения

Возвращаемое значение: -

| Имя аргумента | Описание                                                |
| :-----------: | ------------------------------------------------------- |
| `destination` | Место назначения — указатель, регистр, буфер            |
|   `source`    | Источник — значение по указателю, регистр, буфер, число |

## `buffer_length(buffer)`

Возвращает размер буфера. Обязательное условие — буфер должен оканчиваться на 0

Возвращаемое значение: число

| Имя аргумента | Описание                              |
| :-----------: | ------------------------------------- |
|   `buffer`    | Буфер, длину которого нужно вычислить |

## `sys_print(ptr, size)`

Облегчение для операции [`sys_write`](<#sys_write(file_descriptor%2C-buffer_ptr%2C-size)>) для записи в стандартный файловый дескриптор вывода (`STDOUT`)

Возвращаемое значение: -

| Имя аргумента | Описание                                       |
| :-----------: | ---------------------------------------------- |
|     `ptr`     | Указатель на последовательность бит для вывода |
|    `size`     | Количество бит для вывода                      |

## `exit(code, message = 0)`

Расширение операции [`sys_exit`](<#sys_exit(error_code)>) с возможностью вывода сообщения перед выходом

Возвращаемое значение: -

| Имя аргумента | Описание                                    |
| :-----------: | ------------------------------------------- |
|    `code`     | Число-код, с которым будет произведён выход |
|   `message`   | Буфер с сообщением                          |

## `check_error(operation, message)`

Расширение условной операции `j`, используется после операции `cmp`. В случае удовлетворения операции, будет произведён выход с кодом `-1` с выводом сообщения

| Имя аргумента | Описание                                                                                                                     |
| :-----------: | ---------------------------------------------------------------------------------------------------------------------------- |
|  `operation`  | Вариации условной операции `j` (см. [Документация FASM, Таблица 2.1](https://flatassembler.net/docs.php?article=manual#_2.1) |
|   `message`   | Буфер с сообщением ошибки                                                                                                    |

## `check_type(variable, type, error_message)`

Проверка типа. При несхождении — выход с ошибкой

|  Имя аргумента  | Описание                                                  |
| :-------------: | --------------------------------------------------------- |
|   `variable`    | Указатель на переменную                                   |
|     `type`      | Константа типа (см. [`lib/defines.asm`](lib/defines.asm)) |
| `error_message` | Буфер с сообщением ошибки                                 |
