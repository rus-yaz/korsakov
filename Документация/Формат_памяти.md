# Формат хранения информации на куче

## Общая структура кучи

Куча в языке Корсáков представляет собой динамически выделяемую область памяти, управляемую системой аллокации. Каждый объект в куче имеет заголовок с метаданными и область данных.

## Заголовок блока кучи

Каждый блок в куче начинается с заголовка размером 20 байт (5 × 8 байт):

```
[0-3]   Идентификатор блока ("KORS" = 0x534F524B)
[4-7]   Размер предыдущего блока (0 = крайний блок)
[8-11]  Размер текущего блока
[12-15] Ссылка на предыдущий свободный блок (0 = крайний, 1 = занят)
[16-19] Ссылка на следующий свободный блок (0 = крайний, 1 = занят)
```

## Заголовки типов данных

Каждый объект языка имеет заголовок с метаданными:

### Простые типы (заголовок 8 байт)

- **Целое число**: `[0-7] тип`, `[8-15] значение`
- **Вещественное число**: `[0-7] тип`, `[8-15] значение`
- **Логическое значение**: `[0-7] тип`, `[8-15] значение`
- **Null**: `[0-7] тип`

### Сложные типы (заголовок 32 байта)

- **Строка**: `[0-7] тип`, `[8-15] длина`, `[16-23] вместимость`, `[24-31] указатель на элементы`
- **Список**: `[0-7] тип`, `[8-15] длина`, `[16-23] вместимость`, `[24-31] указатель на элементы`
- **Словарь**: `[0-7] тип`, `[8-15] длина`, `[16-23] вместимость`, `[24-31] указатель на элементы`

### Файл (заголовок 32 байта)

- **Файл**: `[0-7] тип`, `[8-15] имя`, `[16-23] дескриптор`, `[24-31] размер файла`

### Бинарные данные (заголовок 16 байт)

- **Бинарные данные**: `[0-7] тип`, `[8-15] длина`, `[16+] данные`

### Функции (заголовок 56 байт)

- **Функция**: `[0-7] тип`, `[8-15] имя`, `[16-23] тело`, `[24-31] аргументы`, `[32-39] именованные аргументы`, `[40-47] контекст`, `[48-55] флаг встроенной функции`

## Система аллокации

### Страничная аллокация

- Начальный размер страницы: 4KB (0x1000)
- Страницы выделяются через системный вызов `mmap`
- Права доступа: чтение, запись, выполнение

### Управление свободными блоками

- Связанный список свободных блоков
- Каждый свободный блок содержит ссылки на предыдущий и следующий
- При аллокации ищется подходящий по размеру блок
- При освобождении блок объединяется с соседними свободными

### Алгоритм поиска блока

1. Поиск в списке свободных блоков
2. Если подходящий блок не найден — выделение новой страницы
3. Разделение блока, если он больше необходимого
4. Обновление списка свободных блоков

## Типы данных в памяти

### Целое число

```
[0-7]   INTEGER (1)
[8-15]  Значение (64-битное)
```

### Строка

```
[0-7]   STRING (5)
[8-15]  Текущая длина
[16-23] Вместимость
[24-31] Указатель на массив символов
```

### Список

```
[0-7]   LIST (4)
[8-15]  Количество элементов
[16-23] Вместимость
[24-31] Указатель на массив элементов
```

### Бинарные данные

```
[0-7]   BINARY (6)
[8-15]  Длина в байтах
[16+]   Байтовые данные
```

## Управление памятью

### Создание объекта

1. Вычисление необходимого размера
2. Поиск свободного блока в куче
3. Разделение блока при необходимости
4. Инициализация заголовка объекта
5. Возврат указателя на объект

### Освобождение объекта

1. Проверка корректности указателя
2. Объединение с соседними свободными блоками
3. Обновление списка свободных блоков
4. Рекурсивное освобождение для сложных типов

### Автоматическое управление

- Текущая версия требует ручного освобождения через `delete`
- Поддержка подсчета ссылок (планируется)
